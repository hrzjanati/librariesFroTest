{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ÙÙˆÙ†Øª Ø§ÛŒØ±Ø§Ù†â€ŒØ³Ù†Ø³ -->
    <style>
        @font-face {
            font-family: 'IRANSans';
            src: url("{% static 'fonts/IRANSans.woff2' %}") format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        body { font-family: 'IRANSans', Arial, sans-serif; }
        .smooth-scroll { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50">

<!-- Ù‡Ø¯Ø± -->
<header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ø³Ù‡ÛŒÙ„ ğŸ‰</h1>
    <button id="sidebarToggle" class="lg:hidden bg-blue-500 px-3 py-1 rounded hover:bg-blue-400 transition">
        Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§
    </button>
</header>

<!-- overlay Ù…ÙˆØ¨Ø§ÛŒÙ„ -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40 lg:hidden"></div>

<!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
<div class="flex flex-col lg:flex-row max-w-7xl mx-auto gap-6 relative">

    <!-- Ø³ØªÙˆÙ† Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ -->
    <aside id="sidebar" class="w-64 p-4 bg-gray-100 rounded shadow flex-shrink-0
                               fixed lg:static top-0 right-0 h-full lg:h-auto
                               transform translate-x-full lg:translate-x-0
                               transition-transform duration-300 z-50 overflow-y-auto max-h-screen">

        <button id="sidebarClose" class="lg:hidden mb-4 text-gray-600 hover:text-gray-800 font-bold text-xl">
            Ã—
        </button>

        <h2 class="text-lg font-bold mb-4">Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</h2>
        <form id="provinceFilterForm">
            <ul class="space-y-2">
                {% for province in provinces %}
                <li>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="provinces" value="{{ province.id }}"
                               {% if province.id|stringformat:"s" in selected_provinces %}checked{% endif %}
                                 class="province-checkbox">
                        <span>{{ province.name }}</span>
                    </label>
                </li>
                {% empty %}
                <li>Ø§Ø³ØªØ§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</li>
                {% endfor %}
            </ul>
        </form>
    </aside>

    <!-- Ø³ØªÙˆÙ† Ù…Ø­ØªÙˆØ§ -->
    <main class="flex-1 p-4 bg-white rounded shadow overflow-auto">
        <!-- ÙØ±Ù… Ø¬Ø³ØªØ¬Ùˆ -->
        <form method="get" action="" class="flex justify-center mb-6 flex-wrap gap-2">
            <input type="text" name="q" placeholder="Ù†Ø§Ù… Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯..."
                   value="{{ query }}"
                   class="p-2 rounded-lg border border-gray-300 w-60 sm:w-72 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                Ø¬Ø³ØªØ¬Ùˆ ğŸ”
            </button>
        </form>

        <!-- Ù„ÛŒØ³Øª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ -->
        <div id="librariesContainer">
            {% if libraries %}
                <div class="flex flex-col gap-6">
                {% for library in libraries %}
                    <div class="p-4 border-2 border-gray-300 rounded-lg bg-white shadow-sm">
                        <h2 class="text-xl font-semibold mb-1">
                            <a href="{% url 'library_detail' library.id %}" class="hover:underline text-blue-700">
                                {{ library.name }} ({{ library.location }})
                            </a>
                        </h2>
                        <p class="text-sm text-gray-500 mb-3">
                            ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: {{ library.date_of_year|date:"Y/m/d" }}
                        </p>

                        <h3 class="font-semibold mb-2">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²:</h3>
                        <div class="flex overflow-x-auto gap-2 pb-2 -mx-2 px-2 smooth-scroll">
                            {% for item in library.required_items.all %}
                                <div class="flex-shrink-0
                                            w-[90%] sm:w-[45%] md:w-[30%] lg:w-[22%]
                                            min-w-[250px]
                                            bg-gray-100 p-4 rounded-lg border border-gray-300 shadow-md">
                                    <h4 class="font-bold text-lg mb-2">
                                        {{ item.book.name|default:"Ù†Ø§Ù… Ú©ØªØ§Ø¨ Ù†Ø§Ù…Ø´Ø®Øµ"}}
                                    </h4>
                                    <p class="text-sm">Ø¯Ø³ØªÙ‡: {{ item.book.category|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}</p>
                                    <p class="text-sm">ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§Ø²Ù…: {{ item.number_of_required }}</p>
                                    <p class="text-sm">Ù…ÙˆØ¬ÙˆØ¯: {{ item.given_number }}</p>
                                    <p class="text-sm font-semibold mt-2">Ù…Ø¨Ù„Øº: {{ item.amount|intcomma }} Ø±ÛŒØ§Ù„</p>
                                </div>
                            {% empty %}
                                <p>Ù‡ÛŒÚ† Ú©ØªØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p class="text-center font-bold text-gray-700">Ù‡ÛŒÚ† Ú©ØªØ§Ø¨ ÛŒØ§ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
            {% endif %}
        </div>

        <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
        {% if libraries.has_other_pages %}
        <div class="flex justify-center mt-6 flex-wrap gap-2">
            {% if libraries.has_previous %}
                <a href="?page={{ libraries.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% for p in selected_provinces %}&provinces={{ p }}{% endfor %}"
                   class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Ù‚Ø¨Ù„ÛŒ
                </a>
            {% endif %}
            <span class="px-3 py-1 font-semibold">{{ libraries.number }} / {{ libraries.paginator.num_pages }}</span>
            {% if libraries.has_next %}
                <a href="?page={{ libraries.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% for p in selected_provinces %}&provinces={{ p }}{% endfor %}"
                   class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Ø¨Ø¹Ø¯ÛŒ
                </a>
            {% endif %}
        </div>
        {% endif %}
    </main>
</div>

<!-- ÙÙˆØªØ± -->
<footer class="bg-gray-800 text-white p-4 mt-6 text-center">
    Â© 2025 Ù‡Ù…Ù‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª
</footer>

<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
<script>
    // Sidebar Ù…ÙˆØ¨Ø§ÛŒÙ„
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    const closeBtn = document.getElementById('sidebarClose');
    const overlay = document.getElementById('overlay');

    function openSidebar() {
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
    }

    function closeSidebar() {
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('hidden');
    }

    toggleBtn.addEventListener('click', openSidebar);
    closeBtn.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    // ÙÛŒÙ„ØªØ± Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ø¨Ø§ AJAX
    const checkboxes = document.querySelectorAll('.province-checkbox');
    const librariesContainer = document.getElementById('librariesContainer');

    function fetchLibraries() {
        const selected = Array.from(checkboxes)
                              .filter(cb => cb.checked)
                              .map(cb => cb.value);

        const params = new URLSearchParams();
        if (selected.length > 0) {
            params.append('provinces', selected.join(','));
        }
        if (document.querySelector('input[name="q"]')) {
            params.append('q', document.querySelector('input[name="q"]').value);
        }

        fetch(`/libraries/?${params.toString()}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            librariesContainer.innerHTML = html;
        });
    }

    checkboxes.forEach(cb => cb.addEventListener('change', fetchLibraries));
</script>
<script>
const checkboxes = document.querySelectorAll('.province-checkbox');
const librariesContainer = document.getElementById('librariesContainer');

function fetchLibraries() {
    const selected = Array.from(checkboxes)
                          .filter(cb => cb.checked)
                          .map(cb => cb.value);

    const params = new URLSearchParams();
    if (selected.length > 0) {
        params.append('provinces', selected.join(','));
    }

    // Ø§Ú¯Ø± Ø¬Ø³ØªØ¬Ùˆ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput && searchInput.value) {
        params.append('q', searchInput.value);
    }

    fetch(`/?${params.toString()}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.text())
    .then(html => {
        librariesContainer.innerHTML = html;
    });
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener
checkboxes.forEach(cb => cb.addEventListener('change', fetchLibraries));
</script>
</body>
</html>